# ğŸ¯ Quick Reference: Data Persistence in Habit Tracker

## The 3 Core Principles

### 1. **MongoDB is the ONLY Storage** ğŸ—„ï¸
```
âŒ NO localStorage
âŒ NO sessionStorage  
âŒ NO cookies for data
âœ… YES MongoDB only
```

### 2. **Save BEFORE UI Update** ğŸ’¾
```javascript
// Correct flow:
await saveToMongoDB();    // Wait for database save
await loadFromMongoDB();  // Reload fresh data
updateUI();               // Then update interface

// Never do this:
updateUI();               // âŒ UI first
saveToMongoDB();          // âŒ Save later
```

### 3. **Always Fetch Fresh on Load** ğŸ”„
```javascript
// On every page load:
document.addEventListener('DOMContentLoaded', async () => {
    await loadHabits();  // Fetches from MongoDB
    // Now UI is synchronized with database
});
```

---

## Data Structure at a Glance

```javascript
// MongoDB Collection: habits
{
  _id: ObjectId,              // Auto-generated by MongoDB
  
  // User-visible data:
  name: "Exercise",           // What to track
  description: "30 min",      // Optional details
  
  // Persistence core:
  completionHistory: [        // ğŸ”‘ SOURCE OF TRUTH
    { date: "2025-12-20", completed: true },
    { date: "2025-12-21", completed: true },
    { date: "2025-12-22", completed: true }
  ],
  
  // Derived/cached values:
  streak: 3,                  // Calculated from history
  lastCompleted: "2025-12-22", // Last item in history
  
  // Metadata:
  category: "health",
  isActive: true,
  createdAt: "2025-12-20",    // Auto-managed
  updatedAt: "2025-12-22"     // Auto-managed
}
```

---

## Critical Files

| File | Role | Persistence Function |
|------|------|---------------------|
| `models/Habit.js` | Schema definition | Defines what gets saved to MongoDB |
| `config/database.js` | Connection | Connects to MongoDB on startup |
| `routes/habits.js` | API endpoints | Saves/reads from MongoDB |
| `public/js/script.js` | Frontend | Loads from MongoDB on page load |

---

## Common Operations

### âœ… Add Habit
```javascript
// Frontend:
POST /api/habits { name: "Read", description: "30 pages" }

// Backend:
const habit = new Habit({ name, description });
await habit.save();  // ğŸ’¾ Saved to MongoDB

// Result: Persists forever
```

### âœ… Complete Habit
```javascript
// Frontend:
PUT /api/habits/:id/today { completed: true }

// Backend:
const habit = await Habit.findById(id);
await habit.complete();  // Adds to history, updates streak
await habit.save();      // ğŸ’¾ Saved to MongoDB

// Result: Streak persists across reloads
```

### âœ… Load Habits
```javascript
// Frontend:
GET /api/habits

// Backend:
const habits = await Habit.findActive();  // ğŸ“– Read from MongoDB

// Result: Fresh data from database every time
```

### âœ… Delete Habit
```javascript
// Frontend:
DELETE /api/habits/:id

// Backend:
await Habit.findByIdAndDelete(id);  // ğŸ—‘ï¸ Removed from MongoDB

// Result: Gone forever (unless you have backups)
```

---

## Testing Persistence

### Quick Console Test
```javascript
// In browser console:
fetch('/api/habits')
  .then(r => r.json())
  .then(d => console.log('Habits from MongoDB:', d.data));
```

### Page Reload Test
```bash
1. Add a habit called "Test Persistence"
2. Press F5 to reload
3. âœ… If you see "Test Persistence" â†’ IT WORKS!
```

### Server Restart Test
```bash
1. Build some habits with streaks
2. Terminal: Ctrl+C (stop server)
3. Terminal: npm start (restart)
4. Browser: Reload page
5. âœ… If habits & streaks intact â†’ IT WORKS!
```

---

## Troubleshooting

### âŒ Data disappears on reload?
**Check:**
1. Is MongoDB running? `ps aux | grep mongod`
2. Is server connected? Look for "âœ… MongoDB Connected" in logs
3. Is `loadHabits()` being called? Check browser console

### âŒ Streaks not updating?
**Check:**
1. Does habit.complete() save to DB? Add console.log
2. Is loadHabits() called after update? Check network tab
3. Is completionHistory array populated? Check MongoDB

### âŒ Old data showing?
**Solution:**
- Frontend is probably caching
- Clear browser cache (Ctrl+Shift+R)
- Check if loadHabits() is fetching from API

---

## Backup & Restore

### Backup All Habits
```bash
mongoexport --db=habit-tracker --collection=habits --out=backup.json
```

### Restore From Backup
```bash
mongoimport --db=habit-tracker --collection=habits --file=backup.json
```

---

## Where Data Lives

```
Your Computer
  â””â”€â”€ MongoDB Process (mongod)
       â””â”€â”€ Data Directory (/data/db or similar)
            â””â”€â”€ habit-tracker database
                 â””â”€â”€ habits collection
                      â”œâ”€â”€ Document 1 (Habit)
                      â”œâ”€â”€ Document 2 (Habit)
                      â””â”€â”€ Document 3 (Habit)
```

**Even if you:**
- Close browser â†’ Data stays in MongoDB âœ…
- Restart computer â†’ MongoDB restarts, data intact âœ…
- Clear browser cache â†’ Doesn't affect MongoDB âœ…
- Uninstall browser â†’ MongoDB unaffected âœ…

**Only lost if:**
- Delete MongoDB data directory âŒ
- Drop database manually âŒ
- No backups and disk fails âŒ

---

## ğŸ“ Remember

1. **MongoDB = Permanent Storage**
2. **completionHistory = Source of Truth**
3. **Streak = Calculated Value (can be rebuilt)**
4. **Always Load Fresh on Page Load**
5. **Save Before UI Update**

**Your habits are safe in MongoDB!** ğŸ”’
